# scripts/ud
#!/usr/bin/env bash
# chmod +x scripts/ud  <-- ê¶Œí•œ ì—†ìœ¼ë©´ í•œ ë²ˆë§Œ ì‹¤í–‰
set -Eeuo pipefail

REPO_URL="https://x2okmiin.github.io/dokkaebi-inventory/#/"

echo "â–¶ ë°°í¬ ì‹œì‘â€¦"

# 1) ë²„ì „ ì…ë ¥/ì •ê·œí™”
VER="${1:-}"   # ì¸ì1 = 1.0.6 ë˜ëŠ” v1.0.6
if [[ -z "$VER" ]]; then
  read -rp "ë²„ì „ (ì˜ˆ: 1.0.6 ë˜ëŠ” 1.0.6-beta.1): " VER
fi
VER="${VER#v}"  # v ì ‘ë‘ ì œê±°
if [[ -z "$VER" ]]; then
  echo "â›” ë²„ì „ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤."; exit 1
fi

# 2) í˜•ì‹ ê²€ì¦ (SemVer + ì„ íƒì  í”„ë¦¬ë¦´ë¦¬ì¦ˆ)
if [[ ! "$VER" =~ ^[0-9]+(\.[0-9]+){1,2}(-[0-9A-Za-z.-]+)?$ ]]; then
  echo "â›” ë²„ì „ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ì˜ˆ: 1.0.6 ë˜ëŠ” 1.0.6-beta.1"; exit 1
fi

TAG="v$VER"
MSG="${2:-"chore(release): $TAG"}"

# 3) ê¸°ì¡´ íƒœê·¸ ì¤‘ë³µ ì²´í¬
git fetch --tags --quiet || true
if git tag -l | grep -qx "$TAG"; then
  echo "â›” ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íƒœê·¸ì…ë‹ˆë‹¤: $TAG"; exit 1
fi

# 4) package.json ë²„ì „ ë°˜ì˜ (+ ì„ íƒ: .env.local ì—…ë°ì´íŠ¸)
npm pkg set version="$VER"
printf "REACT_APP_VERSION=%s\n" "$VER" > .env.local   # ê¹ƒì— ì•ˆ ì˜¬ë¼ê°€ë„ ë¨(ë³´í†µ .gitignore)

# 5) add/commit (ë³€ê²½ ì—†ìœ¼ë©´ ìƒëµ)
echo "â–¶ Git add & commitâ€¦"
git add -A
if git diff --cached --quiet; then
  echo "â„¹ï¸ ìŠ¤í…Œì´ì§€ ë³€ê²½ ì—†ìŒ â€” ì»¤ë°‹ ìƒëµ"
else
  git commit -m "$MSG"
fi

# 6) íƒœê·¸ & push
echo "â–¶ íƒœê·¸ ìƒì„±: $TAG"
git tag -a "$TAG" -m "$TAG"

echo "â–¶ pushâ€¦"
git push origin main
git push origin "$TAG"

# 7) ë¹Œë“œ (í™˜ê²½ë³€ìˆ˜ ì£¼ì…)
echo "â–¶ ë¹Œë“œâ€¦ (REACT_APP_VERSION=$VER)"
REACT_APP_VERSION="$VER" npm run build

# 8) ë°°í¬
echo "â–¶ ë°°í¬â€¦"
# ë§Œì•½ package.jsonì— "predeploy": "npm run build" ê°€ ìˆë‹¤ë©´
# ë°°í¬ ê³¼ì •ì—ì„œ ë‹¤ì‹œ ë¹Œë“œê°€ ëŒ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì•„ë˜ì²˜ëŸ¼ë„ ì•ˆì „í•¨:
REACT_APP_VERSION="$VER" npm run deploy

echo "âœ… ì—…ë°ì´íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
echo "ğŸ”— ë°”ë¡œ ì ‘ì†í•˜ê¸°:: $REPO_URL"


# ì‹¤í–‰: npm run ud
# ì¸ìë¡œ ë²„ì „ ì„¤ì •: npm run ud -- v1.0.0
