# scripts/ud
#!/usr/bin/env bash
# chmod +x scripts/ud <-- ìž‘ë™ ì•ˆí• ì‹œ ê¶Œí•œ ë¶€ì—¬!
set -Eeuo pipefail

REPO_URL="https://x2okmiin.github.io/dokkaebi-inventory/#/"

echo "â–¶ ë°°í¬ ì‹œìž‘â€¦"

# 1) ë²„ì „ ìž…ë ¥ ë°›ê¸°
VER="${1:-}"
MSG="${2:-"chore(release): v$VER"}"   # ë‘ ë²ˆì§¸ ì¸ìžë¡œ ì»¤ë°‹ ë©”ì‹œì§€ ë°›ê¸°

git add .
git commit -m "$MSG" || echo "ë³€ê²½ ì—†ìŒ"

git tag -a "v$VER" -m "v$VER"
# v ë¶™ì´ê¸° ì „ì— ê²€ì¦ ì¶”ê°€
if [[ ! "$VER" =~ ^[0-9]+(\.[0-9]+){1,2}(-[0-9A-Za-z.-]+)?$ ]]; then
  echo "â›” ë²„ì „ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ì˜ˆ: 0.1.3 ë˜ëŠ” 0.1.3-beta.1"
  exit 1
fi

if [[ -z "$VER" ]]; then
  read -rp "ë²„ì „(ì˜ˆ: 1.2.3-release): " VER
fi
if [[ -z "$VER" ]]; then
  echo "âš ï¸ ë²„ì „ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤."; exit 1
fi

# 2) ê°™ì€ ë²„ì „ íƒœê·¸ê°€ ì´ë¯¸ ìžˆìœ¼ë©´ ì¤‘ë‹¨
if git tag -l | grep -qx "v$VER"; then
  echo "â›” ì´ë¯¸ ì§„í–‰í•œ ì—…ë°ì´íŠ¸ ë²„ì „ìž…ë‹ˆë‹¤. (v$VER)"; exit 1
fi

# 3) add/commit
git add .
if ! git commit -m "v$VER"; then
  echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ ì—†ìŒ â€” ì»¤ë°‹ ê±´ë„ˆëœ€"
fi

# 4) íƒœê·¸ & push
git tag -a "v$VER" -m "v$VER"
git push origin main
git push origin "v$VER"

# 5) ë¹Œë“œ (ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨)
echo "â–¶ ë¹Œë“œâ€¦"
npm run build

# 6) ë°°í¬ (package.jsonì˜ deploy ì‹¤í–‰)
echo "â–¶ ë°°í¬â€¦"
npm run deploy

echo "âœ… ì—…ë°ì´íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
echo "ðŸ”— ë°”ë¡œ ì ‘ì†í•˜ê¸°:: $REPO_URL"

# ì‹¤í–‰: npm run ud
# ì¸ìžë¡œ ë²„ì „ ì„¤ì •: npm run ud -- v1.0.0