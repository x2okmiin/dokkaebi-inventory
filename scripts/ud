# scripts/ud
#!/usr/bin/env bash
# chmod +x scripts/ud <-- ì‘ë™ ì•ˆí• ì‹œ ê¶Œí•œ ì–»ê¸°!
set -Eeuo pipefail

REPO_URL="https://x2okmiin.github.io/dokkaebi-inventory/#/"

echo "â–¶ ë°°í¬ ì‹œì‘â€¦"

# 1) ë²„ì „ ì…ë ¥/ì •ê·œí™”
VER="${1:-}"                      # ì¸ì 1 = ë²„ì „ (0.1.3 ë˜ëŠ” v0.1.3)
if [[ -z "$VER" ]]; then
  read -rp "ë²„ì „ (ì˜ˆ: ì˜ˆ: 0.1.3 ë˜ëŠ” 0.1.3-beta.1): " VER
fi
VER="${VER#v}"                    # ì‚¬ìš©ìê°€ v ì ‘ë‘ì‚¬ ë„£ì–´ë„ ì œê±°
if [[ -z "$VER" ]]; then
  echo "â›” ë²„ì „ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤."; exit 1
fi

# 2) í˜•ì‹ ê²€ì¦ (SemVer + ì„ íƒì  í”„ë¦¬ë¦´ë¦¬ì¦ˆ)
if [[ ! "$VER" =~ ^[0-9]+(\.[0-9]+){1,2}(-[0-9A-Za-z.-]+)?$ ]]; then
  echo "â›” ë²„ì „ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ì˜ˆ: 0.1.3 ë˜ëŠ” 0.1.3-beta.1"; exit 1
fi

TAG="v$VER"
MSG="${2:-"(release): $TAG"}"   # ì¸ì 2 = ì»¤ë°‹ ë©”ì‹œì§€(ì˜µì…˜)

# 3) ê¸°ì¡´ íƒœê·¸ ì¤‘ë³µ ì²´í¬(ë¡œì»¬/ì›ê²©)
git fetch --tags --quiet || true
if git tag -l | grep -qx "$TAG"; then
  echo "â›” ì´ë¯¸ ì§„í–‰í•œ ì—…ë°ì´íŠ¸ ë²„ì „ì…ë‹ˆë‹¤. ($TAG)"; exit 1
fi
# 4) package.json ë²„ì „ ë°˜ì˜ (+ ì•±ì—ì„œ í‘œì‹œí•˜ê³  ì‹¶ìœ¼ë©´ .env.localë„ ê°±ì‹ )
npm pkg set version="$VER"
printf "REACT_APP_VERSION=%s\n" "$VER" > .env.local

# 5) add/commit (ë³€ê²½ ì—†ìœ¼ë©´ ê±´ë„ˆëœ€)
echo "â–¶ Git add & commitâ€¦"
git add -A
if git diff --cached --quiet; then
  echo "â„¹ï¸ ìŠ¤í…Œì´ì§€ëœ ë³€ê²½ ì—†ìŒ â€” ì»¤ë°‹ ìƒëµ"
else
  git commit -m "$MSG"
fi

# 6) íƒœê·¸ & push
echo "â–¶ íƒœê·¸ ìƒì„±: $TAG"
git tag -a "$TAG" -m "$TAG"

echo "â–¶ pushâ€¦"
git push origin main
git push origin "$TAG"

# 7) ë¹Œë“œ (ì‹¤íŒ¨ ì‹œ ì¤‘ë‹¨)
echo "â–¶ ë¹Œë“œâ€¦"
npm run build

# 8) ë°°í¬ (package.jsonì˜ deploy ì‹¤í–‰)
echo "â–¶ ë°°í¬â€¦"
npm run deploy

echo "âœ… ì—…ë°ì´íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
echo "ğŸ”— ë°”ë¡œ ì ‘ì†í•˜ê¸°:: $REPO_URL"

# ì‹¤í–‰: npm run ud
# ì¸ìë¡œ ë²„ì „ ì„¤ì •: npm run ud -- v1.0.0